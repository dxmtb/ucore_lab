# SMP实验报告
计24 田博 2012011346

## 完成情况
每个核心可以运行不同的程序，调度器可以正常调度。不同核心的同步问题没有解决。

可以进入sh，执行一个mptest的程序（我加的）。我加了一个系统调用用来获取当前进程的运行cpu的id。

这个mptest会fork一些子进程，每个子进程不断输出自己的id和cpu id，从此验证SMP正常运行。

ls之类的程序也可以正常执行。

## 基本思路

拷贝xv6的mp.[ch]，lapic.c，ioapic.c代码，参考main.c修改init.c，并针对一些细节进行修改。

## 一些细节
1. SMP使用KCPU段和gs段寄存器来保证每个CPU有独立的current、cpu等变量，所以时刻需要保护gs寄存器的内容。
2. 由于使用ioapic控制中断，所以需要在ioapic打开各个IRQ。并且处理完毕发送ACK。
3. lapic和ioapic的代码拷贝xv6即可，需要修改的是类型名称。
4. 其它的CPU（AP）启动起来后，段、页偏移均为空。此时需要重新启用段、页机制。实际做法是采用一段汇编启用偏移为-KERNBASE，之后跳转到C代码后再通过类似原先lab中的hack启用页机制并且使得当前代码仍然能够正确运行，（实际上是映射低位页表等于高位）。再清零段偏移，恢复页表。
5. 需要注意的是，由于页偏移的存在，一些硬件地址例如LAPIC无法访问，需要建立相应的页映射。